# Redis Sentinel for testing
#
# This Docker Compose file creates a Redis Sentinel setup with:
#   - 1 master (redis-master)
#   - 1 replica (redis-replica)
#   - 3 sentinels (sentinel-1, sentinel-2, sentinel-3)
#
# Usage:
#   docker-compose -f docker/docker-compose.sentinel.yml up -d
#   docker-compose -f docker/docker-compose.sentinel.yml down
#
# Sentinel Configuration:
#   - Sentinels: localhost:26379, localhost:26380, localhost:26381
#   - Master: localhost:7379 (internal: 6379)
#   - Replica: localhost:7380 (internal: 6380)
#   - Service name: mymaster
#   - Quorum: 2 (requires 2 sentinels to agree on failure)
#
# Connection:
#   Set REDIS_SENTINEL_URL=localhost:26379,localhost:26380,localhost:26381
#
# Notes:
#   - Uses ports 7379/7380 to avoid conflicts with devcontainer Redis (6379)
#   - All sentinels share the same base config (sentinel.conf)
#   - Announce ports are set via SENTINEL_ANNOUNCE_PORT environment variable
#   - Entrypoint script resolves master hostname to IP for proper configuration

services:
  redis-master:
    image: redis:7.0
    container_name: redis-master
    ports:
      - "7379:6379"
    command: >
      redis-server
      --port 6379
      --slave-announce-ip 127.0.0.1
      --slave-announce-port 7379
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - redis-sentinel-net

  redis-replica:
    image: redis:7.0
    container_name: redis-replica
    ports:
      - "7380:6380"
    command: redis-server --port 6380 --replicaof redis-master 6379 --replica-announce-ip 127.0.0.1 --replica-announce-port 7380
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6380", "ping"]
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - redis-sentinel-net

  sentinel-1:
    image: redis:7.0
    container_name: sentinel-1
    ports:
      - "26379:26379"
    environment:
      - SENTINEL_ANNOUNCE_PORT=26379
    volumes:
      - ./sentinel.conf:/etc/redis/sentinel.conf
      - ./sentinel-entrypoint.sh:/usr/local/bin/sentinel-entrypoint.sh
    entrypoint: ["/usr/local/bin/sentinel-entrypoint.sh"]
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - redis-sentinel-net

  sentinel-2:
    image: redis:7.0
    container_name: sentinel-2
    ports:
      - "26380:26379"
    environment:
      - SENTINEL_ANNOUNCE_PORT=26380
    volumes:
      - ./sentinel.conf:/etc/redis/sentinel.conf
      - ./sentinel-entrypoint.sh:/usr/local/bin/sentinel-entrypoint.sh
    entrypoint: ["/usr/local/bin/sentinel-entrypoint.sh"]
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - redis-sentinel-net

  sentinel-3:
    image: redis:7.0
    container_name: sentinel-3
    ports:
      - "26381:26379"
    environment:
      - SENTINEL_ANNOUNCE_PORT=26381
    volumes:
      - ./sentinel.conf:/etc/redis/sentinel.conf
      - ./sentinel-entrypoint.sh:/usr/local/bin/sentinel-entrypoint.sh
    entrypoint: ["/usr/local/bin/sentinel-entrypoint.sh"]
    depends_on:
      redis-master:
        condition: service_healthy
    networks:
      - redis-sentinel-net

networks:
  redis-sentinel-net:
    driver: bridge
